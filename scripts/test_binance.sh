#!/bin/bash
# ============================================
# å¿«é€Ÿæµ‹è¯•å¸å®‰APIè®¿é—®
# ============================================

set -e

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

echo "=========================================="
echo "ğŸ§ª å¸å®‰APIæœ€å°åŒ–æµ‹è¯•"
echo "=========================================="

# 1. æ£€æŸ¥buildç›®å½•
if [ ! -d "build" ]; then
    echo "åˆ›å»º build ç›®å½•..."
    mkdir build
fi

cd build

# 2. è¿è¡ŒCMakeé…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
if [ ! -f "Makefile" ]; then
    echo ""
    echo "é¦–æ¬¡è¿è¡Œï¼Œé…ç½®CMake..."
    cmake ..
fi

# 3. åªç¼–è¯‘æµ‹è¯•ç¨‹åºï¼ˆä¸ç¼–è¯‘æ•´ä¸ªé¡¹ç›®ï¼ŒèŠ‚çœæ—¶é—´ï¼‰
echo ""
echo "ç¼–è¯‘æµ‹è¯•ç¨‹åº..."
make test_binance_minimal -j$(sysctl -n hw.ncpu 2>/dev/null || echo 4)

# 4. æ£€æŸ¥æ˜¯å¦ç¼–è¯‘æˆåŠŸ
if [ ! -f "bin/test_binance_minimal" ]; then
    echo ""
    echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"
    exit 1
fi

echo ""
echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
echo ""
echo "=========================================="
echo "è¿è¡Œæµ‹è¯•..."
echo "=========================================="
echo ""

# 5. è¿è¡Œæµ‹è¯•
./bin/test_binance_minimal

echo ""
echo "=========================================="
echo "æµ‹è¯•å®Œæˆï¼"
echo "=========================================="

