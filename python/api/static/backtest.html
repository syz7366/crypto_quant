<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡åŒ–å›æµ‹å¯è§†åŒ–ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-run {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-run:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-run:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            padding: 30px;
            display: none;
        }

        .results.active {
            display: block;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .card.positive {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .card.negative {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .card-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #212529;
        }

        .chart-container {
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .chart {
            width: 100%;
            height: 500px;
            min-height: 500px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .metric-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 600;
        }

        .metric-value {
            font-size: 16px;
            font-weight: bold;
            color: #212529;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .trades-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .trades-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .trades-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-buy {
            background: #d4edda;
            color: #155724;
        }

        .badge-sell {
            background: #f8d7da;
            color: #721c24;
        }

        .error {
            display: none;
            padding: 20px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 6px;
            margin: 20px 30px;
        }

        .error.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸš€ é‡åŒ–å›æµ‹å¯è§†åŒ–ç³»ç»Ÿ</h1>
            <p>åŸºäºC++é«˜æ€§èƒ½å¼•æ“ + Python APIçš„ä¸“ä¸šå›æµ‹å¹³å°</p>
        </div>

        <!-- å‚æ•°æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div class="form-grid">
                <div class="form-group">
                    <label>äº¤æ˜“å¯¹</label>
                    <input type="text" id="symbol" value="BTCUSDT">
                </div>
                <div class="form-group">
                    <label>Kçº¿å‘¨æœŸ</label>
                    <select id="interval">
                        <option value="1m">1åˆ†é’Ÿ</option>
                        <option value="5m">5åˆ†é’Ÿ</option>
                        <option value="15m">15åˆ†é’Ÿ</option>
                        <option value="1h" selected>1å°æ—¶</option>
                        <option value="4h">4å°æ—¶</option>
                        <option value="1d">1å¤©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Kçº¿æ•°é‡</label>
                    <input type="number" id="limit" value="500" min="100" max="5000">
                </div>
                <div class="form-group">
                    <label>å¿«çº¿å‘¨æœŸ</label>
                    <input type="number" id="fast_period" value="10" min="2" max="100">
                </div>
                <div class="form-group">
                    <label>æ…¢çº¿å‘¨æœŸ</label>
                    <input type="number" id="slow_period" value="30" min="5" max="200">
                </div>
                <div class="form-group">
                    <label>åˆå§‹èµ„é‡‘ (USDT)</label>
                    <input type="number" id="initial_capital" value="10000" min="100">
                </div>
            </div>
            <button class="btn-run" onclick="runBacktest()">ğŸš€ å¼€å§‹å›æµ‹</button>
        </div>

        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨è¿è¡Œå›æµ‹ï¼Œè¯·ç¨å€™...</p>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div class="error" id="error"></div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="results" id="results">
            <!-- æ¦‚è§ˆå¡ç‰‡ -->
            <div class="summary-cards" id="summary-cards"></div>

            <!-- æƒç›Šæ›²çº¿ -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ æƒç›Šæ›²çº¿</div>
                <div id="equity-chart" class="chart"></div>
            </div>

            <!-- å›æ’¤æ›²çº¿ -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“‰ å›æ’¤æ›²çº¿</div>
                <div id="drawdown-chart" class="chart"></div>
            </div>

            <!-- æ€§èƒ½æŒ‡æ ‡ -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“Š æ€§èƒ½æŒ‡æ ‡</div>
                <div class="metrics-grid" id="metrics-grid"></div>
            </div>

            <!-- äº¤æ˜“è®°å½• -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“ äº¤æ˜“è®°å½•ï¼ˆæœ€è¿‘20ç¬”ï¼‰</div>
                <table class="trades-table" id="trades-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>ä¿¡å·</th>
                            <th>ä»·æ ¼</th>
                            <th>æ•°é‡</th>
                            <th>ç›ˆäº</th>
                        </tr>
                    </thead>
                    <tbody id="trades-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let equityChart = null;
        let drawdownChart = null;

        async function runBacktest() {
            const button = document.querySelector('.btn-run');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const errorDiv = document.getElementById('error');

            // é‡ç½®çŠ¶æ€
            button.disabled = true;
            loading.classList.add('active');
            results.classList.remove('active');
            errorDiv.classList.remove('active');

            // æ”¶é›†å‚æ•°
            const params = {
                symbol: document.getElementById('symbol').value,
                interval: document.getElementById('interval').value,
                limit: parseInt(document.getElementById('limit').value),
                fast_period: parseInt(document.getElementById('fast_period').value),
                slow_period: parseInt(document.getElementById('slow_period').value),
                initial_capital: parseFloat(document.getElementById('initial_capital').value),
                commission_rate: 0.001,
                slippage_rate: 0.0005,
                strategy_name: "ma_cross",
                position_size: 1.0
            };

            try {
                const response = await fetch('/api/v1/backtest/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });

                if (!response.ok) {
                    const error = await response.json();
                    // å¤„ç†422éªŒè¯é”™è¯¯
                    if (response.status === 422 && error.detail && Array.isArray(error.detail)) {
                        const messages = error.detail.map(e => `${e.loc.join('.')}: ${e.msg}`).join('; ');
                        throw new Error(`å‚æ•°éªŒè¯å¤±è´¥: ${messages}`);
                    }
                    throw new Error(error.detail || 'å›æµ‹å¤±è´¥');
                }

                const data = await response.json();
                displayResults(data);
                results.classList.add('active');

            } catch (error) {
                errorDiv.textContent = `é”™è¯¯: ${error.message || error}`;
                errorDiv.classList.add('active');
                console.error('å›æµ‹é”™è¯¯:', error);
            } finally {
                loading.classList.remove('active');
                button.disabled = false;
            }
        }

        function displayResults(data) {
            // 1. æ˜¾ç¤ºæ¦‚è§ˆå¡ç‰‡
            displaySummaryCards(data);

            // 2. ç»˜åˆ¶æƒç›Šæ›²çº¿
            drawEquityCurve(data);

            // 3. ç»˜åˆ¶å›æ’¤æ›²çº¿
            drawDrawdownCurve(data);

            // 4. æ˜¾ç¤ºæ€§èƒ½æŒ‡æ ‡
            displayMetrics(data.metrics);

            // 5. æ˜¾ç¤ºäº¤æ˜“è®°å½•
            displayTrades(data.trades);
        }

        function displaySummaryCards(data) {
            const container = document.getElementById('summary-cards');
            const returnClass = data.total_return >= 0 ? 'positive' : 'negative';

            container.innerHTML = `
                <div class="card ${returnClass}">
                    <div class="card-label">æ€»æ”¶ç›Šç‡</div>
                    <div class="card-value">${data.total_return.toFixed(2)}%</div>
                </div>
                <div class="card">
                    <div class="card-label">æœ€ç»ˆæƒç›Š</div>
                    <div class="card-value">${data.final_equity.toFixed(2)}</div>
                </div>
                <div class="card">
                    <div class="card-label">æ€»äº¤æ˜“æ¬¡æ•°</div>
                    <div class="card-value">${data.total_trades}</div>
                </div>
                <div class="card positive">
                    <div class="card-label">ç›ˆåˆ©æ¬¡æ•°</div>
                    <div class="card-value">${data.winning_trades}</div>
                </div>
                <div class="card negative">
                    <div class="card-label">äºæŸæ¬¡æ•°</div>
                    <div class="card-value">${data.losing_trades}</div>
                </div>
                <div class="card">
                    <div class="card-label">èƒœç‡</div>
                    <div class="card-value">${(data.winning_trades / Math.max(data.winning_trades + data.losing_trades, 1) * 100).toFixed(1)}%</div>
                </div>
            `;
        }

        function drawEquityCurve(data) {
            try {
                // æ ¼å¼åŒ–æ—¶é—´æˆ³
                const timestamps = data.timestamps.map(ts => {
                    const date = new Date(ts);
                    return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                });

                if (equityChart) {
                    equityChart.dispose();
                }

                equityChart = echarts.init(document.getElementById('equity-chart'));

                const option = {
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            const idx = params[0].dataIndex;
                            const date = new Date(data.timestamps[idx]);
                            const time = date.toLocaleString('zh-CN');
                            return `æ—¶é—´: ${time}<br/>æƒç›Š: <b>${params[0].value.toFixed(2)} USDT</b>`;
                        }
                    },
                    grid: {
                        left: '70px',
                        right: '30px',
                        top: '30px',
                        bottom: '80px'
                    },
                    xAxis: {
                        type: 'category',
                        data: timestamps,
                        boundaryGap: false,
                        axisLabel: {
                            rotate: 45,
                            interval: Math.max(1, Math.floor(timestamps.length / 15)),
                            fontSize: 10
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'USDT',
                        scale: true,
                        axisLabel: {
                            formatter: '{value}',
                            fontSize: 10
                        }
                    },
                    dataZoom: [{
                        type: 'inside',
                        start: 0,
                        end: 100
                    }, {
                        type: 'slider',
                        start: 0,
                        end: 100,
                        height: 20,
                        bottom: 5
                    }],
                    series: [{
                        name: 'æƒç›Š',
                        type: 'line',
                        data: data.equity_curve,
                        smooth: false,
                        symbol: 'none',
                        lineStyle: {
                            color: '#667eea',
                            width: 2
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                offset: 0,
                                color: 'rgba(102, 126, 234, 0.3)'
                            }, {
                                offset: 1,
                                color: 'rgba(102, 126, 234, 0.05)'
                            }])
                        }
                    }]
                };

                equityChart.setOption(option);
            } catch (error) {
                console.error('ç»˜åˆ¶æƒç›Šæ›²çº¿å¤±è´¥:', error);
            }
        }

        function drawDrawdownCurve(data) {
            try {
                // æ ¼å¼åŒ–æ—¶é—´æˆ³
                const timestamps = data.timestamps.map(ts => {
                    const date = new Date(ts);
                    return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                });

                const drawdownPercent = data.drawdown_curve.map(d => (d * 100));

                if (drawdownChart) {
                    drawdownChart.dispose();
                }

                drawdownChart = echarts.init(document.getElementById('drawdown-chart'));

                const option = {
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            const idx = params[0].dataIndex;
                            const date = new Date(data.timestamps[idx]);
                            const time = date.toLocaleString('zh-CN');
                            return `æ—¶é—´: ${time}<br/>å›æ’¤: <b>${params[0].value.toFixed(2)}%</b>`;
                        }
                    },
                    grid: {
                        left: '70px',
                        right: '30px',
                        top: '30px',
                        bottom: '80px'
                    },
                    xAxis: {
                        type: 'category',
                        data: timestamps,
                        boundaryGap: false,
                        axisLabel: {
                            rotate: 45,
                            interval: Math.max(1, Math.floor(timestamps.length / 15)),
                            fontSize: 10
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'å›æ’¤ (%)',
                        inverse: true,
                        min: 0,
                        axisLabel: {
                            formatter: '{value}%',
                            fontSize: 10
                        }
                    },
                    dataZoom: [{
                        type: 'inside',
                        start: 0,
                        end: 100
                    }, {
                        type: 'slider',
                        start: 0,
                        end: 100,
                        height: 20,
                        bottom: 5
                    }],
                    series: [{
                        name: 'å›æ’¤',
                        type: 'line',
                        data: drawdownPercent,
                        smooth: false,
                        symbol: 'none',
                        lineStyle: {
                            color: '#dc3545',
                            width: 2
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                offset: 0,
                                color: 'rgba(220, 53, 69, 0.3)'
                            }, {
                                offset: 1,
                                color: 'rgba(220, 53, 69, 0.05)'
                            }])
                        }
                    }]
                };

                drawdownChart.setOption(option);
            } catch (error) {
                console.error('ç»˜åˆ¶å›æ’¤æ›²çº¿å¤±è´¥:', error);
            }
        }

        function displayMetrics(metrics) {
            const container = document.getElementById('metrics-grid');

            container.innerHTML = `
                <div class="metric-item">
                    <span class="metric-label">å¹´åŒ–æ”¶ç›Šç‡</span>
                    <span class="metric-value">${(metrics.annualized_return * 100).toFixed(2)}%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">ç´¯è®¡æ”¶ç›Šç‡</span>
                    <span class="metric-value">${(metrics.cumulative_return * 100).toFixed(2)}%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">æœ€å¤§å›æ’¤</span>
                    <span class="metric-value">${(metrics.max_drawdown * 100).toFixed(2)}%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">å¤æ™®æ¯”ç‡</span>
                    <span class="metric-value">${metrics.sharpe_ratio.toFixed(4)}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">ç´¢æè¯ºæ¯”ç‡</span>
                    <span class="metric-value">${metrics.sortino_ratio.toFixed(4)}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">å¡ç›æ¯”ç‡</span>
                    <span class="metric-value">${metrics.calmar_ratio.toFixed(4)}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">æ³¢åŠ¨ç‡</span>
                    <span class="metric-value">${(metrics.volatility * 100).toFixed(2)}%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">ç›ˆäºæ¯”</span>
                    <span class="metric-value">${metrics.profit_loss_ratio.toFixed(2)}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">æœ€å¤§è¿ç»­ç›ˆåˆ©</span>
                    <span class="metric-value">${metrics.max_consecutive_wins} æ¬¡</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">æœ€å¤§è¿ç»­äºæŸ</span>
                    <span class="metric-value">${metrics.max_consecutive_losses} æ¬¡</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">å¹³å‡æŒä»“æ—¶é—´</span>
                    <span class="metric-value">${metrics.avg_holding_period.toFixed(2)} å¤©</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">å¹´åŒ–äº¤æ˜“é¢‘ç‡</span>
                    <span class="metric-value">${metrics.trade_frequency_per_year.toFixed(2)} æ¬¡/å¹´</span>
                </div>
            `;
        }

        function displayTrades(trades) {
            const tbody = document.getElementById('trades-tbody');
            const recentTrades = trades.slice(-20).reverse();

            tbody.innerHTML = recentTrades.map(trade => `
                <tr>
                    <td>${new Date(trade.timestamp).toLocaleString('zh-CN')}</td>
                    <td><span class="badge badge-${trade.signal.toLowerCase()}">${trade.signal}</span></td>
                    <td>${trade.price.toFixed(2)}</td>
                    <td>${trade.quantity.toFixed(6)}</td>
                    <td style="color: ${trade.pnl >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">
                        ${trade.pnl.toFixed(2)}
                    </td>
                </tr>
            `).join('');
        }

        // å“åº”å¼å›¾è¡¨
        window.addEventListener('resize', () => {
            if (equityChart) equityChart.resize();
            if (drawdownChart) drawdownChart.resize();
        });
    </script>
</body>
</html>

