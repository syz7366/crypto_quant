# WebSocketå®æ—¶è¡Œæƒ…æ•°æ®è®¢é˜…ï¼šè¡Œä¸šå®è·µ vs å½“å‰å®ç°å¯¹æ¯”

## ğŸ“Š ç›®å½•

1. [è¡Œä¸šæ ‡å‡†æ¶æ„](#è¡Œä¸šæ ‡å‡†æ¶æ„)
2. [å½“å‰å®ç°åˆ†æ](#å½“å‰å®ç°åˆ†æ)
3. [åŠŸèƒ½å¯¹æ¯”](#åŠŸèƒ½å¯¹æ¯”)
4. [å·®è·åˆ†æ](#å·®è·åˆ†æ)
5. [æ”¹è¿›å»ºè®®](#æ”¹è¿›å»ºè®®)

---

## ğŸ—ï¸ è¡Œä¸šæ ‡å‡†æ¶æ„

### ä¸“ä¸šé‡åŒ–äº¤æ˜“ç³»ç»Ÿçš„WebSocketæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç­–ç•¥å±‚ (Strategy Layer)                    â”‚
â”‚  - æ¥æ”¶ç»Ÿä¸€çš„æ•°æ®ç»“æ„ (OHLCV, Ticker, OrderBook)       â”‚
â”‚  - ä¸å…³å¿ƒæ•°æ®æ¥æº                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ•°æ®æŠ½è±¡å±‚ (Data Abstraction Layer)             â”‚
â”‚  - ç»Ÿä¸€çš„æ•°æ®æ¥å£                                       â”‚
â”‚  - æ•°æ®æ ¼å¼è½¬æ¢                                         â”‚
â”‚  - æ•°æ®è´¨é‡æ£€æŸ¥                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      WebSocketç®¡ç†å±‚ (WebSocket Manager Layer)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è¿æ¥ç®¡ç† (Connection Manager)                    â”‚  â”‚
â”‚  â”‚  - è¿æ¥æ± ç®¡ç†                                      â”‚  â”‚
â”‚  â”‚  - è‡ªåŠ¨é‡è¿æœºåˆ¶                                    â”‚  â”‚
â”‚  â”‚  - å¿ƒè·³ä¿æ´» (Ping/Pong)                          â”‚  â”‚
â”‚  â”‚  - è¿æ¥çŠ¶æ€ç›‘æ§                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è®¢é˜…ç®¡ç† (Subscription Manager)                  â”‚  â”‚
â”‚  â”‚  - è®¢é˜…/å–æ¶ˆè®¢é˜…                                   â”‚  â”‚
â”‚  â”‚  - è®¢é˜…çŠ¶æ€è·Ÿè¸ª                                    â”‚  â”‚
â”‚  â”‚  - æ‰¹é‡è®¢é˜…                                        â”‚  â”‚
â”‚  â”‚  - è®¢é˜…å¤±è´¥é‡è¯•                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ¶ˆæ¯å¤„ç† (Message Handler)                        â”‚  â”‚
â”‚  â”‚  - æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²                                    â”‚  â”‚
â”‚  â”‚  - èƒŒå‹æ§åˆ¶ (Backpressure)                       â”‚  â”‚
â”‚  â”‚  - æ¶ˆæ¯å»é‡                                        â”‚  â”‚
â”‚  â”‚  - æ¶ˆæ¯éªŒè¯                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é”™è¯¯å¤„ç† (Error Handler)                          â”‚  â”‚
â”‚  â”‚  - é”™è¯¯åˆ†ç±»                                        â”‚  â”‚
â”‚  â”‚  - è‡ªåŠ¨æ¢å¤ç­–ç•¥                                    â”‚  â”‚
â”‚  â”‚  - é”™è¯¯é€šçŸ¥                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      äº¤æ˜“æ‰€é€‚é…å±‚ (Exchange Adapter Layer)             â”‚
â”‚  â”œâ”€â”€ BinanceAdapter                                    â”‚
â”‚  â”œâ”€â”€ OKXAdapter                                        â”‚
â”‚  â”œâ”€â”€ BybitAdapter                                      â”‚
â”‚  â””â”€â”€ ...                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å½“å‰å®ç°åˆ†æ

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ç­–ç•¥å±‚ (ä½¿ç”¨å›è°ƒå‡½æ•°)             â”‚
â”‚  subscribe_kline(..., callback)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    WebSocketClientBase (åŸºç±»)           â”‚
â”‚  - è¿æ¥ç®¡ç† (åŸºç¡€)                       â”‚
â”‚  - å¼‚æ­¥IOå¤„ç†                            â”‚
â”‚  - SSL/TLSæ”¯æŒ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    BinanceWebSocketClient (å­ç±»)        â”‚
â”‚  - å¸å®‰ç‰¹å®šæ¶ˆæ¯è§£æ                      â”‚
â”‚  - å¸å®‰è®¢é˜…æ ¼å¼                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å½“å‰å®ç°ç‰¹ç‚¹

**âœ… ä¼˜ç‚¹ï¼š**
1. **åˆ†å±‚è®¾è®¡** - åŸºç±»+å­ç±»ï¼Œæ˜“äºæ‰©å±•
2. **å¼‚æ­¥IO** - ä½¿ç”¨Boost.Beastï¼Œé«˜æ€§èƒ½
3. **SSL/TLS** - å®‰å…¨åŠ å¯†è¿æ¥
4. **ç»Ÿä¸€æ¥å£** - ç­–ç•¥å±‚ä¸å…³å¿ƒäº¤æ˜“æ‰€å·®å¼‚

**âš ï¸ ä¸è¶³ï¼š**
1. **å•è¿æ¥** - ä¸€ä¸ªå®¢æˆ·ç«¯åªèƒ½ä¸€ä¸ªè¿æ¥
2. **æ— é‡è¿æœºåˆ¶** - è¿æ¥æ–­å¼€åä¸ä¼šè‡ªåŠ¨é‡è¿
3. **æ— å¿ƒè·³ä¿æ´»** - æ²¡æœ‰Ping/Pongæœºåˆ¶
4. **æ— æ¶ˆæ¯ç¼“å†²** - ç›´æ¥å›è°ƒï¼Œå¯èƒ½ä¸¢å¤±æ•°æ®
5. **æ— è®¢é˜…ç®¡ç†** - æ— æ³•åŠ¨æ€æ·»åŠ /åˆ é™¤è®¢é˜…
6. **é”™è¯¯å¤„ç†ç®€å•** - åªæœ‰åŸºæœ¬é”™è¯¯æ—¥å¿—

---

## ğŸ“‹ åŠŸèƒ½å¯¹æ¯”

### 1. è¿æ¥ç®¡ç†

| åŠŸèƒ½ | è¡Œä¸šæ ‡å‡† | å½“å‰å®ç° | å·®è· |
|------|---------|---------|------|
| **è¿æ¥æ± ** | âœ… æ”¯æŒå¤šè¿æ¥ | âŒ å•è¿æ¥ | âš ï¸ æ— æ³•åŒæ—¶è®¢é˜…å¤šä¸ªæµ |
| **è‡ªåŠ¨é‡è¿** | âœ… æŒ‡æ•°é€€é¿é‡è¿ | âŒ æ—  | âš ï¸ è¿æ¥æ–­å¼€åæ— æ³•æ¢å¤ |
| **è¿æ¥çŠ¶æ€ç›‘æ§** | âœ… å®æ—¶çŠ¶æ€ | âš ï¸ åŸºç¡€çŠ¶æ€ | âš ï¸ ç¼ºå°‘è¯¦ç»†çŠ¶æ€ |
| **è¿æ¥å¥åº·æ£€æŸ¥** | âœ… å®šæœŸæ£€æŸ¥ | âŒ æ—  | âš ï¸ æ— æ³•æ£€æµ‹åƒµå°¸è¿æ¥ |
| **è¿æ¥å¤±è´¥é‡è¯•** | âœ… æ™ºèƒ½é‡è¯• | âŒ æ—  | âš ï¸ å¤±è´¥åæ— æ³•æ¢å¤ |

**è¡Œä¸šæ ‡å‡†ç¤ºä¾‹ï¼š**
```cpp
// ä¸“ä¸šç³»ç»Ÿ
class ConnectionManager {
    std::map<std::string, std::shared_ptr<WebSocketConnection>> connections_;
    
    void reconnect_with_backoff(const std::string& id) {
        int delay = 1;  // åˆå§‹å»¶è¿Ÿ1ç§’
        while (!is_connected(id)) {
            connect(id);
            wait(delay);
            delay = std::min(delay * 2, 60);  // æŒ‡æ•°é€€é¿ï¼Œæœ€å¤§60ç§’
        }
    }
};
```

**å½“å‰å®ç°ï¼š**
```cpp
// å½“å‰ç³»ç»Ÿ - æ— é‡è¿æœºåˆ¶
void WebSocketClientBase::on_close(beast::error_code ec) {
    connected_ = false;  // ä»…æ ‡è®°ä¸ºæ–­å¼€ï¼Œä¸ä¼šé‡è¿
}
```

---

### 2. å¿ƒè·³ä¿æ´» (Ping/Pong)

| åŠŸèƒ½ | è¡Œä¸šæ ‡å‡† | å½“å‰å®ç° | å·®è· |
|------|---------|---------|------|
| **Ping/Pongæœºåˆ¶** | âœ… å®šæœŸå‘é€Ping | âŒ æ—  | âš ï¸ æ— æ³•æ£€æµ‹è¿æ¥æ˜¯å¦å­˜æ´» |
| **å¿ƒè·³è¶…æ—¶æ£€æµ‹** | âœ… è¶…æ—¶è‡ªåŠ¨é‡è¿ | âŒ æ—  | âš ï¸ åƒµå°¸è¿æ¥æ— æ³•æ£€æµ‹ |
| **å¿ƒè·³é—´éš”é…ç½®** | âœ… å¯é…ç½® | âŒ æ—  | âš ï¸ æ— æ³•è‡ªå®šä¹‰ |

**è¡Œä¸šæ ‡å‡†ç¤ºä¾‹ï¼š**
```cpp
// ä¸“ä¸šç³»ç»Ÿ
class WebSocketClient {
    void start_heartbeat() {
        timer_.expires_after(std::chrono::seconds(30));
        timer_.async_wait([this](beast::error_code ec) {
            if (!ec) {
                ws_.async_ping("heartbeat", [this](beast::error_code ec) {
                    if (ec) {
                        // Pingå¤±è´¥ï¼Œé‡è¿
                        reconnect();
                    } else {
                        start_heartbeat();  // ç»§ç»­å¿ƒè·³
                    }
                });
            }
        });
    }
};
```

**å½“å‰å®ç°ï¼š**
```cpp
// å½“å‰ç³»ç»Ÿ - æ— å¿ƒè·³æœºåˆ¶
// ä¾èµ–WebSocketåè®®æœ¬èº«çš„è¶…æ—¶ï¼Œä½†æ— æ³•ä¸»åŠ¨æ£€æµ‹
```

---

### 3. è®¢é˜…ç®¡ç†

| åŠŸèƒ½ | è¡Œä¸šæ ‡å‡† | å½“å‰å®ç° | å·®è· |
|------|---------|---------|------|
| **åŠ¨æ€è®¢é˜…** | âœ… è¿è¡Œæ—¶æ·»åŠ /åˆ é™¤ | âŒ æ„é€ æ—¶è®¢é˜… | âš ï¸ æ— æ³•åŠ¨æ€ç®¡ç† |
| **æ‰¹é‡è®¢é˜…** | âœ… ä¸€æ¬¡è®¢é˜…å¤šä¸ªæµ | âŒ ä¸€æ¬¡ä¸€ä¸ª | âš ï¸ æ•ˆç‡ä½ |
| **è®¢é˜…çŠ¶æ€è·Ÿè¸ª** | âœ… è·Ÿè¸ªæ¯ä¸ªè®¢é˜… | âŒ æ—  | âš ï¸ æ— æ³•çŸ¥é“è®¢é˜…æ˜¯å¦æˆåŠŸ |
| **è®¢é˜…å¤±è´¥é‡è¯•** | âœ… è‡ªåŠ¨é‡è¯• | âŒ æ—  | âš ï¸ è®¢é˜…å¤±è´¥æ— æ³•æ¢å¤ |
| **å–æ¶ˆè®¢é˜…** | âœ… æ”¯æŒ | âŒ æ—  | âš ï¸ æ— æ³•å–æ¶ˆè®¢é˜… |

**è¡Œä¸šæ ‡å‡†ç¤ºä¾‹ï¼š**
```cpp
// ä¸“ä¸šç³»ç»Ÿ
class SubscriptionManager {
    std::map<std::string, Subscription> subscriptions_;
    
    void subscribe(const std::vector<Subscription>& subs) {
        // æ‰¹é‡è®¢é˜…
        nlohmann::json msg = {
            {"method", "SUBSCRIBE"},
            {"params", build_params(subs)},
            {"id", generate_id()}
        };
        send_message(msg);
    }
    
    void unsubscribe(const std::vector<std::string>& streams) {
        // å–æ¶ˆè®¢é˜…
    }
    
    bool is_subscribed(const std::string& stream) const {
        return subscriptions_.count(stream) > 0;
    }
};
```

**å½“å‰å®ç°ï¼š**
```cpp
// å½“å‰ç³»ç»Ÿ - è®¢é˜…å³è¿æ¥
void BinanceWebSocketClient::subscribe_kline(...) {
    // æ¯æ¬¡è®¢é˜…éƒ½åˆ›å»ºæ–°è¿æ¥
    connect("stream.binance.com", "9443", path);
    // æ— æ³•åœ¨åŒä¸€è¿æ¥ä¸Šæ·»åŠ æ›´å¤šè®¢é˜…
}
```

---

### 4. æ¶ˆæ¯å¤„ç†

| åŠŸèƒ½ | è¡Œä¸šæ ‡å‡† | å½“å‰å®ç° | å·®è· |
|------|---------|---------|------|
| **æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²** | âœ… é˜Ÿåˆ—ç¼“å†² | âŒ ç›´æ¥å›è°ƒ | âš ï¸ å›è°ƒé˜»å¡ä¼šå½±å“æ¥æ”¶ |
| **èƒŒå‹æ§åˆ¶** | âœ… æµé‡æ§åˆ¶ | âŒ æ—  | âš ï¸ æ¶ˆæ¯è¿‡å¿«å¯èƒ½ä¸¢å¤± |
| **æ¶ˆæ¯å»é‡** | âœ… å»é‡æœºåˆ¶ | âŒ æ—  | âš ï¸ å¯èƒ½é‡å¤å¤„ç† |
| **æ¶ˆæ¯éªŒè¯** | âœ… æ ¼å¼éªŒè¯ | âš ï¸ åŸºç¡€éªŒè¯ | âš ï¸ éªŒè¯ä¸å¤Ÿä¸¥æ ¼ |
| **æ¶ˆæ¯ç»Ÿè®¡** | âœ… ç»Ÿè®¡æŒ‡æ ‡ | âŒ æ—  | âš ï¸ æ— æ³•ç›‘æ§æ€§èƒ½ |

**è¡Œä¸šæ ‡å‡†ç¤ºä¾‹ï¼š**
```cpp
// ä¸“ä¸šç³»ç»Ÿ
class MessageHandler {
    std::queue<Message> message_queue_;
    std::thread processing_thread_;
    
    void on_message(const std::string& raw) {
        // 1. éªŒè¯æ¶ˆæ¯
        if (!validate(raw)) return;
        
        // 2. å»é‡
        if (is_duplicate(raw)) return;
        
        // 3. åŠ å…¥é˜Ÿåˆ—ï¼ˆéé˜»å¡ï¼‰
        message_queue_.push(parse(raw));
        
        // 4. èƒŒå‹æ§åˆ¶
        if (message_queue_.size() > MAX_QUEUE_SIZE) {
            drop_oldest();  // ä¸¢å¼ƒæœ€æ—§çš„æ¶ˆæ¯
        }
    }
    
    void process_messages() {
        while (running_) {
            if (!message_queue_.empty()) {
                auto msg = message_queue_.front();
                message_queue_.pop();
                callback_(msg);  // è°ƒç”¨ç”¨æˆ·å›è°ƒ
            }
        }
    }
};
```

**å½“å‰å®ç°ï¼š**
```cpp
// å½“å‰ç³»ç»Ÿ - ç›´æ¥å›è°ƒ
void WebSocketClientBase::on_read(...) {
    std::string message = beast::buffers_to_string(buffer_.data());
    parse_message(message);  // ç›´æ¥è§£æå¹¶å›è°ƒ
    // âš ï¸ å¦‚æœå›è°ƒå‡½æ•°æ‰§è¡Œæ—¶é—´é•¿ï¼Œä¼šé˜»å¡åç»­æ¶ˆæ¯æ¥æ”¶
}
```

---

### 5. é”™è¯¯å¤„ç†

| åŠŸèƒ½ | è¡Œä¸šæ ‡å‡† | å½“å‰å®ç° | å·®è· |
|------|---------|---------|------|
| **é”™è¯¯åˆ†ç±»** | âœ… åˆ†ç±»å¤„ç† | âš ï¸ åŸºç¡€æ—¥å¿— | âš ï¸ æ— æ³•åŒºåˆ†é”™è¯¯ç±»å‹ |
| **è‡ªåŠ¨æ¢å¤** | âœ… æ™ºèƒ½æ¢å¤ | âŒ æ—  | âš ï¸ é”™è¯¯åæ— æ³•è‡ªåŠ¨æ¢å¤ |
| **é”™è¯¯é€šçŸ¥** | âœ… å›è°ƒé€šçŸ¥ | âŒ æ—  | âš ï¸ ç”¨æˆ·æ— æ³•æ„ŸçŸ¥é”™è¯¯ |
| **é”™è¯¯ç»Ÿè®¡** | âœ… ç»Ÿè®¡é”™è¯¯ç‡ | âŒ æ—  | âš ï¸ æ— æ³•ç›‘æ§ç¨³å®šæ€§ |
| **é™çº§ç­–ç•¥** | âœ… é™çº§å¤„ç† | âŒ æ—  | âš ï¸ æ— å¤‡ç”¨æ–¹æ¡ˆ |

**è¡Œä¸šæ ‡å‡†ç¤ºä¾‹ï¼š**
```cpp
// ä¸“ä¸šç³»ç»Ÿ
enum class ErrorType {
    NETWORK_ERROR,      // ç½‘ç»œé”™è¯¯ - å¯é‡è¯•
    AUTH_ERROR,        // è®¤è¯é”™è¯¯ - éœ€è¦é‡æ–°è®¤è¯
    RATE_LIMIT,         // é™æµ - éœ€è¦ç­‰å¾…
    INVALID_MESSAGE,    // æ¶ˆæ¯æ ¼å¼é”™è¯¯ - è·³è¿‡
    UNKNOWN             // æœªçŸ¥é”™è¯¯
};

class ErrorHandler {
    void handle_error(beast::error_code ec) {
        ErrorType type = classify_error(ec);
        
        switch (type) {
            case ErrorType::NETWORK_ERROR:
                reconnect_with_backoff();
                break;
            case ErrorType::RATE_LIMIT:
                wait_and_retry();
                break;
            case ErrorType::AUTH_ERROR:
                reauthenticate();
                break;
            default:
                notify_user(type, ec.message());
        }
    }
};
```

**å½“å‰å®ç°ï¼š**
```cpp
// å½“å‰ç³»ç»Ÿ - ç®€å•æ—¥å¿—
void WebSocketClientBase::on_read(beast::error_code ec, ...) {
    if (ec) {
        std::cerr << "è¯»å–å¤±è´¥: " << ec.message() << std::endl;
        connected_ = false;  // ä»…æ ‡è®°æ–­å¼€ï¼Œæ— æ¢å¤æœºåˆ¶
        return;
    }
}
```

---

### 6. æ€§èƒ½ä¼˜åŒ–

| åŠŸèƒ½ | è¡Œä¸šæ ‡å‡† | å½“å‰å®ç° | å·®è· |
|------|---------|---------|------|
| **é›¶æ‹·è´è§£æ** | âœ… é¿å…æ‹·è´ | âš ï¸ æœ‰æ‹·è´ | âš ï¸ æ€§èƒ½æœ‰æå‡ç©ºé—´ |
| **æ‰¹é‡å¤„ç†** | âœ… æ‰¹é‡å¤„ç†æ¶ˆæ¯ | âŒ é€æ¡å¤„ç† | âš ï¸ æ•ˆç‡è¾ƒä½ |
| **å†…å­˜æ± ** | âœ… å†…å­˜å¤ç”¨ | âŒ æ¯æ¬¡åˆ†é… | âš ï¸ å†…å­˜åˆ†é…å¼€é”€ |
| **çº¿ç¨‹æ± ** | âœ… å¤šçº¿ç¨‹å¤„ç† | âš ï¸ å•çº¿ç¨‹ | âš ï¸ æ— æ³•å……åˆ†åˆ©ç”¨CPU |

---

## ğŸ¯ å·®è·æ€»ç»“

### æ ¸å¿ƒå·®è·ï¼ˆP0 - å¿…é¡»å®ç°ï¼‰

1. **è‡ªåŠ¨é‡è¿æœºåˆ¶** âš ï¸
   - **å½±å“**ï¼šè¿æ¥æ–­å¼€åæ— æ³•æ¢å¤ï¼Œéœ€è¦æ‰‹åŠ¨é‡å¯
   - **ä¼˜å…ˆçº§**ï¼šP0

2. **å¿ƒè·³ä¿æ´»æœºåˆ¶** âš ï¸
   - **å½±å“**ï¼šæ— æ³•æ£€æµ‹åƒµå°¸è¿æ¥ï¼Œå¯èƒ½ä¸¢å¤±æ•°æ®
   - **ä¼˜å…ˆçº§**ï¼šP0

3. **è®¢é˜…ç®¡ç†** âš ï¸
   - **å½±å“**ï¼šæ— æ³•åŠ¨æ€ç®¡ç†è®¢é˜…ï¼Œæ— æ³•æ‰¹é‡è®¢é˜…
   - **ä¼˜å…ˆçº§**ï¼šP0

### é‡è¦å·®è·ï¼ˆP1 - åº”è¯¥å®ç°ï¼‰

4. **æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²** âš ï¸
   - **å½±å“**ï¼šå›è°ƒé˜»å¡ä¼šå½±å“æ¶ˆæ¯æ¥æ”¶
   - **ä¼˜å…ˆçº§**ï¼šP1

5. **é”™è¯¯å¤„ç†å¢å¼º** âš ï¸
   - **å½±å“**ï¼šé”™è¯¯åæ— æ³•è‡ªåŠ¨æ¢å¤
   - **ä¼˜å…ˆçº§**ï¼šP1

### ä¼˜åŒ–å·®è·ï¼ˆP2 - å¯ä»¥ä¼˜åŒ–ï¼‰

6. **æ€§èƒ½ä¼˜åŒ–** âš ï¸
   - **å½±å“**ï¼šæ€§èƒ½æœ‰æå‡ç©ºé—´
   - **ä¼˜å…ˆçº§**ï¼šP2

---

## ğŸ’¡ æ”¹è¿›å»ºè®®

### é˜¶æ®µ1ï¼šæ ¸å¿ƒåŠŸèƒ½å¢å¼ºï¼ˆP0ï¼‰

#### 1.1 æ·»åŠ è‡ªåŠ¨é‡è¿æœºåˆ¶

```cpp
class WebSocketClientBase {
private:
    int reconnect_attempts_ = 0;
    int max_reconnect_attempts_ = 10;
    std::chrono::milliseconds reconnect_delay_ = std::chrono::milliseconds(1000);
    
    void schedule_reconnect() {
        if (reconnect_attempts_ < max_reconnect_attempts_) {
            reconnect_attempts_++;
            auto delay = reconnect_delay_ * (1 << reconnect_attempts_);  // æŒ‡æ•°é€€é¿
            timer_.expires_after(delay);
            timer_.async_wait([this](beast::error_code ec) {
                if (!ec) {
                    reconnect();
                }
            });
        }
    }
};
```

#### 1.2 æ·»åŠ å¿ƒè·³ä¿æ´»

```cpp
class WebSocketClientBase {
private:
    net::steady_timer heartbeat_timer_;
    
    void start_heartbeat() {
        heartbeat_timer_.expires_after(std::chrono::seconds(30));
        heartbeat_timer_.async_wait([this](beast::error_code ec) {
            if (!ec && connected_) {
                ws_.async_ping("heartbeat", [this](beast::error_code ec) {
                    if (ec) {
                        // Pingå¤±è´¥ï¼Œé‡è¿
                        schedule_reconnect();
                    } else {
                        start_heartbeat();  // ç»§ç»­å¿ƒè·³
                    }
                });
            }
        });
    }
};
```

#### 1.3 æ·»åŠ è®¢é˜…ç®¡ç†

```cpp
class SubscriptionManager {
    std::map<std::string, Subscription> subscriptions_;
    
    void add_subscription(const Subscription& sub) {
        subscriptions_[sub.stream_id] = sub;
        if (is_connected()) {
            send_subscribe_message(sub);
        }
    }
    
    void remove_subscription(const std::string& stream_id) {
        subscriptions_.erase(stream_id);
        if (is_connected()) {
            send_unsubscribe_message(stream_id);
        }
    }
};
```

### é˜¶æ®µ2ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆP1ï¼‰

#### 2.1 æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²

```cpp
class MessageQueue {
    std::queue<Message> queue_;
    std::mutex mutex_;
    std::condition_variable cv_;
    
    void push(const Message& msg) {
        std::lock_guard<std::mutex> lock(mutex_);
        queue_.push(msg);
        cv_.notify_one();
    }
    
    Message pop() {
        std::unique_lock<std::mutex> lock(mutex_);
        cv_.wait(lock, [this] { return !queue_.empty(); });
        Message msg = queue_.front();
        queue_.pop();
        return msg;
    }
};
```

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“è¡¨

| ç»´åº¦ | è¡Œä¸šæ ‡å‡† | å½“å‰å®ç° | å·®è·ç­‰çº§ |
|------|---------|---------|---------|
| **è¿æ¥ç®¡ç†** | â­â­â­â­â­ | â­â­ | âš ï¸ è¾ƒå¤§ |
| **å¿ƒè·³ä¿æ´»** | â­â­â­â­â­ | â­ | âš ï¸ å¾ˆå¤§ |
| **è®¢é˜…ç®¡ç†** | â­â­â­â­â­ | â­â­ | âš ï¸ è¾ƒå¤§ |
| **æ¶ˆæ¯å¤„ç†** | â­â­â­â­â­ | â­â­â­ | âš ï¸ ä¸­ç­‰ |
| **é”™è¯¯å¤„ç†** | â­â­â­â­â­ | â­â­ | âš ï¸ è¾ƒå¤§ |
| **æ€§èƒ½ä¼˜åŒ–** | â­â­â­â­â­ | â­â­â­ | âš ï¸ ä¸­ç­‰ |

**æ€»ä½“è¯„åˆ†ï¼š**
- **è¡Œä¸šæ ‡å‡†**ï¼šâ­â­â­â­â­ (5/5)
- **å½“å‰å®ç°**ï¼šâ­â­ (2/5)
- **å·®è·**ï¼šéœ€è¦å®ç°æ ¸å¿ƒåŠŸèƒ½ï¼ˆé‡è¿ã€å¿ƒè·³ã€è®¢é˜…ç®¡ç†ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

### ä¼˜å…ˆçº§æ’åº

1. **P0 - è‡ªåŠ¨é‡è¿æœºåˆ¶**ï¼ˆ1-2å¤©ï¼‰
   - æŒ‡æ•°é€€é¿é‡è¿
   - è¿æ¥çŠ¶æ€ç®¡ç†

2. **P0 - å¿ƒè·³ä¿æ´»æœºåˆ¶**ï¼ˆ1å¤©ï¼‰
   - Ping/Pongå®ç°
   - è¶…æ—¶æ£€æµ‹

3. **P0 - è®¢é˜…ç®¡ç†**ï¼ˆ2-3å¤©ï¼‰
   - åŠ¨æ€è®¢é˜…/å–æ¶ˆè®¢é˜…
   - è®¢é˜…çŠ¶æ€è·Ÿè¸ª

4. **P1 - æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²**ï¼ˆ1-2å¤©ï¼‰
   - é˜Ÿåˆ—å®ç°
   - èƒŒå‹æ§åˆ¶

5. **P1 - é”™è¯¯å¤„ç†å¢å¼º**ï¼ˆ1-2å¤©ï¼‰
   - é”™è¯¯åˆ†ç±»
   - è‡ªåŠ¨æ¢å¤ç­–ç•¥

**é¢„è®¡æ€»å·¥ä½œé‡ï¼š6-10å¤©**

---

## ğŸ“š å‚è€ƒèµ„æº

- [WebSocket RFC 6455](https://tools.ietf.org/html/rfc6455)
- [Binance WebSocket API](https://binance-docs.github.io/apidocs/spot/cn/#websocket)
- [Boost.Beast Documentation](https://www.boost.org/doc/libs/1_89_0/libs/beast/doc/html/index.html)

